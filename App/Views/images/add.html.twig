{% extends "base.html.twig" %}

{% block title %}Ajouter une image{% endblock %}

{% block stylesheet %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.css"
          integrity="sha256-p6xU9YulB7E2Ic62/PX+h59ayb3PBJ0WFTEQxq0EjHw=" crossorigin="anonymous"/>
    <style type="text/css">
        @media only screen and (max-width: 760px) {
            .dropfile {
                display: none !important;
            }
        }


        .dropfile {
            width: 100%;
            height: 300px;
            padding: 15px;
            border-style: dashed;
            border-color: #000;
            border-width: 1px;
            background-color: #ffffff;
            color: #000;
            transition: all 0.3s ease-out;
        }

        .dropfile.active {
            background-color: #ccc;
        }

        .custom-label-file:hover {
            cursor: pointer;
        }

        input[type="file"] {
            display: none;
        }

        .list-group-item {
            background: none;
            border: none;
        }

        #btnContinuer {
            display: none;
        }

        #loaderUpload {
            background-color: rgba(0, 0, 0, 0.5);
            position: fixed;
            top:0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
        }
    </style>
{% endblock %}

{% block body %}
    <div id="result"></div>
    <form id="formAdd" class="container-fluid pt-5">
        <h1 class="text-center">Ajouter une image</h1>
        <hr class="my-4">
        <div class="row">
            <div class="col-md-5 mx-auto">
                <div class="dropfile d-flex align-items-center justify-content-center"></div>
                <label class="btn btn-outline-dark rounded-0 float-right my-3 custom-label-file"> Ajouter une image
                    <input type="file" id="inputImage">
                </label>
            </div>
        </div>
        <div class="row">
            <div class="col-md-5 mx-auto" id="preview">
            </div>
        </div>
        <div class="row">
            <div class="col text-center">
                <button type="submit" class="btn btn-outline-dark btn-lg rounded-0 mb-3" id="btnContinuer">Continuer
                </button>
            </div>
        </div>
    </form>
    <form id="formImage" class="container-fluid">
    </form>
    <div id="loaderUpload">
        <div class="d-flex justify-content-center align-items-center w-100 h-100">
            <div class="spinner-border text-light" role="status"><span class="sr-only">Loading...</span></div>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.js"
            integrity="sha256-T0Vest3yCU7pafRw9r+settMBX6JkKN06dqBnpQ8d30=" crossorigin="anonymous"></script>
    <script type="text/javascript">
        var file_to_upload = null;

        function makePreview(files) {
            $('#preview').html("");
            $('#formImage').html("");
            let file = files[0];
            let html;
            if (options.whitelist.indexOf(file.type) !== -1) {
                let url = URL.createObjectURL(file);
                html = $('<img>');
                html.attr('src', url);
                html.addClass('w-100 img-thumbnails shadow mb-3');

                file_to_upload = file;

                $('#btnContinuer').fadeIn(100);
            } else {
                html = $('<div class="alert alert-danger rounded-0 mb-3">Fichier invalide</div>');
                file_to_upload = null;
            }
            $('#preview').html(html);
        }

        var options = {
            message: "DÃ©posez votre image ici",
            whitelist: [
                "image/png",
                "image/jpeg",
                "image/gif",
            ]
        };

        $.fn.dropfile = function (args) {
            if (args) $.extend(options, args);
            this.each(function () {
                $(this).html(
                    $('<span>')
                        .addClass('lead')
                        .append(options.message)
                );

                $(this).bind({
                    dragenter: function (e) {
                        e.preventDefault();
                    },
                    dragover: function (e) {
                        e.preventDefault();
                        $(this).addClass('active');
                    },
                    dragleave: function (e) {
                        e.preventDefault();
                        $(this).removeClass('active');
                    },
                });

                this.addEventListener('drop', function (e) {
                    e.preventDefault();
                    $(this).removeClass('active');
                    let files = e.dataTransfer.files;
                    makePreview(files);
                }, false);
            });
        };

        $('#inputImage').change(function (e) {
            makePreview(this.files)
        });
        $('.dropfile').dropfile();

        $('#formAdd').on('submit', function (e) {
            e.preventDefault();
            if (file_to_upload !== null) {
                let formData = new FormData();
                formData.append('image', file_to_upload);

                let xhr = new XMLHttpRequest();
                xhr.open('POST', '/devoir-idc2019/ajax/image-pending');
                xhr.file = file_to_upload;

                xhr.onreadystatechange = function () {
                    if (xhr.readyState === XMLHttpRequest.DONE) {
                        $('#btnContinuer').fadeOut(100);
                        $('#formImage').html(xhr.responseText);
                        $('#formTabs').tabs();
                    }
                    $('#btnContinuer').html("Continuer");
                };

                xhr.addEventListener('loadstart', function (e) {
                    $('#btnContinuer').html(
                        '<div class="spinner-grow" role="status">' +
                        '  <span class="sr-only">Loading...</span>' +
                        '</div>'
                    );
                });
                xhr.send(formData);

            } else {
                let html = $('<div class="alert alert-danger rounded-0 mb-3">Fichier invalide ou inexistant</div>');
                $('#preview').html(html);
            }
        });

        $('#formImage').on('submit', function (e) {
            e.preventDefault();
            let formData = new FormData(this);
            formData.append("file", file_to_upload);
            $.ajax({
                url: '/devoir-idc2019/ajax/upload',
                method: 'post',
                cache: false,
                contentType: false,
                processData: false,
                data: formData,
                beforeSend: function () {
                    $('#loaderUpload').fadeIn();
                },
                success: function (data) {
                    $('#loaderUpload').fadeOut();
                    window.location = '/devoir-idc2019/';
                }
            })
        });

    </script>
{% endblock %}
